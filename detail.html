<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MYTHS ARE THE PUBLIC DREAM.</title>
  <link rel="stylesheet" href="styles.css">
  <script>
    // Scrolling title text
    const titleText = "MYTHS ARE THE PUBLIC DREAM. ";
    let titleIndex = 0;
    function scrollTitle() {
      document.title = titleText.substring(titleIndex) + titleText.substring(0, titleIndex);
      titleIndex = (titleIndex + 1) % titleText.length;
    }
    setInterval(scrollTitle, 200);
  </script>
</head>
<body>
  <main class="container">
    <a href="myths.html" class="back-link">← Back to myths</a>

    <article class="detail-article" id="mythDetail">
      <div class="loading">Loading...</div>
    </article>

    <a href="myths.html" class="back-link">← Back to myths</a>
  </main>

  <footer class="site-footer">
    <p>
      PUBLIC DREAM is a project by
      <a href="https://adamrgarcia.studio" target="_blank" rel="noopener noreferrer" class="body-link">Adam R Garcia</a>.
      All information and imagery pulled from Wikipedia, which means it's probably not all correct, but a good place to think
      about how we create myths through time, and how they create us in return. "Myth is the public dream and dream is the private myth." —Joseph Campbell
    </p>
  </footer>

  <script src="myths.js"></script>
  <script src="wiki.js"></script>
  <script>
    function renderMyth(myth, extract, imageUrl, imageCaption) {
      // Build a base description from our curated summary
      const summarySentences = myth.summary
        ? myth.summary.split(/[.!?]+/).filter(s => s.trim().length > 0)
        : [];
      const baseDescription = myth.summary || '';

      // Add extra context from Wikipedia extract to ensure rich descriptions
      const extractText = extract || '';
      const extractSentences = extractText.split(/[.!?]+/).filter(s => s.trim().length > 0);
      // Take up to 5 sentences from extract for richer content
      const extraSentences = extractSentences.slice(0, 5);
      const extraText = extraSentences.length > 0
        ? extraSentences.map(s => s.trim()).join('. ') + '.'
        : '';

      let description = extraText
        ? [baseDescription, extraText].filter(Boolean).join(' ')
        : baseDescription;

      // Clean up incomplete text patterns from Wikipedia extracts
      description = description
        // Remove incomplete parenthetical expressions like "(i. e", "(e. g", etc.
        .replace(/\(i\.\s*e\s*$/i, '')
        .replace(/\(e\.\s*g\s*$/i, '')
        .replace(/\([^)]*$/g, '') // Remove any incomplete parentheses at the end
        // Remove incomplete abbreviations at the end
        .replace(/\s+[a-z]\.\s*$/i, '')
        // Clean up trailing whitespace and punctuation issues
        .trim()
        .replace(/\s+\.$/, '.') // Fix " ." to "."
        .replace(/\s+,\s*$/, '') // Remove trailing comma
        .replace(/\s+$/g, '') // Remove trailing whitespace
        // Ensure it ends with a period
        .replace(/[.!?]*$/, '') + '.';

      // Get related myths
      const relatedMyths = getRelatedMyths(myth);

      // Wikipedia article URL used for image click-through and caption
      const wikipediaUrl = `https://en.wikipedia.org/wiki/${encodeURIComponent(myth.wikipediaTitle)}`;

      // Custom image caption for specific myths
      let finalImageCaption = imageCaption;
      if (myth.slug === 'christian-underworld' && imageUrl) {
        finalImageCaption = "A detail from Hieronymus Bosch's depiction of Hell (16th century).";
      }
      if (myth.slug === 'christian-eschatology' && imageUrl) {
        finalImageCaption = "Revelation 13:16–14:4 on Papyrus 47 (recto; c. 250 AD).";
      }
      if (myth.slug === 'christian-cosmogony' && imageUrl) {
        finalImageCaption = "The Creation (1896–1902), by James Tissot.";
      }
      if (myth.slug === 'christian-anthropogony' && imageUrl) {
        finalImageCaption = "The Fall of Man by Peter Paul Rubens, 1628–29.";
      }
      if (myth.slug === 'izkali' && imageUrl) {
        finalImageCaption = "The Aztec Sun Stone, currently displayed at the National Anthropology Museum in Mexico City. Basalt, created sometime between 1502 and 1520.";
      }
      if (myth.slug === 'aztec-anthropogony' && imageUrl) {
        finalImageCaption = "Mictlantecuhtli (left), god of death, the lord of the Underworld and Quetzalcoatl (right), god of wisdom, life, knowledge, morning star, patron of the winds and light, the lord of the West. Together they symbolize life and death.";
      }
      if (myth.slug === 'aztec-cosmogony' && imageUrl) {
        finalImageCaption = "The Aztec Sun Stone, currently displayed at the National Anthropology Museum in Mexico City. Basalt, created sometime between 1502 and 1520.";
      }
      if (myth.slug === 'chinese-eschatology' && imageUrl) {
        finalImageCaption = "Nine Dragons, handscroll section, by Chen Rong, AD 1244, Song dynasty, Museum of Fine Arts, Boston.";
      }
      if (myth.slug === 'anubis-underworld' && imageUrl) {
        finalImageCaption = "The 'Weighing of the Heart' from the Book of the Dead from the Papyrus of Hunefer, dated to the 19th Dynasty around 1275 BCE. The deceased Hunefer is taken into the judgment hall by the deity Anubis, who weighs a portion of Hunefer's soul, represented by his heart. This ritual is completed with Ammit the Devourer awaiting the result. Next, the triumphant Hunefer, having passed the test, is presented by the falcon-headed Horus to Osiris, seated in his shrine with Isis, Nephthys and the four sons of Horus.";
      }
      if (myth.slug === 'egyptian-anthropogony' && imageUrl) {
        finalImageCaption = "The Egyptian god Khnum was usually depicted with the head of a ram.";
      }
      if (myth.slug === 'greek-cosmogony' && imageUrl) {
        finalImageCaption = "Chaos painting by George Frederic Watts.";
      }
      if (myth.slug === 'greek-anthropogony' && imageUrl) {
        finalImageCaption = "Prometheus tortured by the eagle (black-figure kylix, 560-550 BC, Vatican Museums).";
      }
      if (myth.slug === 'greek-eschatology' && imageUrl) {
        finalImageCaption = "Zeus holding a thunderbolt. Zeus de Smyrne, discovered in Smyrna in 1680.";
      }
      if (myth.slug === 'greek-underworld' && imageUrl) {
        finalImageCaption = "Hades (Pluton) depicted sitting on the left holding a bident in his left hand, next to Persephone (Proserpina), with Cerberus (Kerberos).";
      }

      // Render the detail page
      document.getElementById('mythDetail').innerHTML = `
        <header class="detail-header">
          <h1 class="detail-title">${myth.title}</h1>
          <div class="detail-meta">
            <button class="detail-tag detail-tag-button" data-culture="${myth.culture}">${myth.culture}</button>
            <button class="detail-tag detail-tag-button" data-type="${myth.type}">${myth.type}</button>
          </div>
          ${myth.themes.length > 0 ? `
            <div class="detail-themes">
              ${myth.themes.map(theme => `
                <span class="detail-theme">${theme}</span>
              `).join('')}
            </div>
          ` : ''}
        </header>

        <section class="detail-section">
          <h2 class="detail-section-title">Description</h2>
          <div class="detail-section-content">
            ${description} <span class="source-caption"><a href="https://en.wikipedia.org/wiki/${encodeURIComponent(myth.wikipediaTitle)}" target="_blank" rel="noopener noreferrer" class="source-caption-link">Source</a></span>
          </div>
          ${imageUrl ? `
            <a href="${wikipediaUrl}" target="_blank" rel="noopener noreferrer">
              <img src="${imageUrl}" alt="${myth.title}" class="myth-image">
            </a>
            <p class="myth-image-caption">${finalImageCaption || `Image from the Wikipedia article on ${myth.wikipediaTitle}`}</p>
          ` : ''}
        </section>

        ${relatedMyths.length > 0 ? `
          <section class="related-section">
            <h2 class="related-title">Related Myths</h2>
            <div class="related-grid">
              ${relatedMyths.map(related => `
                <a href="detail.html?slug=${related.slug}" class="related-card">
                  <h3 class="related-card-title">${related.title}</h3>
                  <div class="related-card-meta">
                    <span>${related.culture}</span>
                    <span>•</span>
                    <span>${related.type}</span>
                  </div>
                  <p class="related-card-summary">${related.summary}</p>
                </a>
              `).join('')}
            </div>
          </section>
        ` : ''}
      `;

      // Update page title
      document.title = myth.title;
    }

    async function loadMythDetail() {
      const params = new URLSearchParams(window.location.search);
      const slug = params.get('slug');

      if (!slug) {
        document.getElementById('mythDetail').innerHTML = '<div class="empty-state">Myth not found</div>';
        return;
      }

      const myth = getMythBySlug(slug);

      if (!myth) {
        document.getElementById('mythDetail').innerHTML = '<div class="empty-state">Myth not found</div>';
        return;
      }

      // Make metadata tags clickable to cross-reference back to myths list
      document.addEventListener('click', (event) => {
        const target = event.target;
        if (target.classList && target.classList.contains('detail-tag-button')) {
          if (target.dataset.culture) {
            window.location.href = `myths.html?culture=${encodeURIComponent(target.dataset.culture)}`;
          }
          if (target.dataset.type) {
            window.location.href = `myths.html?type=${encodeURIComponent(target.dataset.type)}`;
          }
        }
      });

      // Set body background based on myth type
      if (myth.type) {
        document.body.setAttribute('data-type', myth.type);
      }

      // Render immediately with myth data (don't wait for Wikipedia)
      renderMyth(myth, null, null, null);

      // Fetch Wikipedia extract (with image) in the background and update when ready
      // Try to get more comprehensive content plus a lead image
      getWikipediaExtractWithImage(myth.wikipediaTitle).then(result => {
        let extract = result?.extract || null;
        let imageUrl = result?.imageUrl || null;
        let imageCaption = result?.imageCaption || null;

        // Custom image URL for Greek Underworld
        if (myth.slug === 'greek-underworld') {
          // Fetch the specific image "Aidoneus_&_Persephone.png" from Wikimedia Commons
          fetch(`https://en.wikipedia.org/w/api.php?action=query&titles=File:Aidoneus_%26_Persephone.png&prop=imageinfo&iiprop=url&iiurlwidth=600&format=json&origin=*`)
            .then(response => response.json())
            .then(data => {
              const pages = data.query?.pages;
              if (pages) {
                const pageId = Object.keys(pages)[0];
                const page = pages[pageId];
                const fileUrl = page?.imageinfo?.[0]?.thumburl || page?.imageinfo?.[0]?.url;
                if (fileUrl) {
                  imageUrl = fileUrl;
                  renderMyth(myth, extract, imageUrl, imageCaption);
                }
              }
            })
            .catch(() => {
              // Fallback to default image if fetch fails
            });
          // Render with extract even if image hasn't loaded yet
          if (extract) {
            renderMyth(myth, extract, imageUrl, imageCaption);
          }
          // Skip culture mythology fallback for Greek Underworld since we're using a custom image
        } else if (myth.slug === 'greek-cosmogony') {
          // Fetch the specific Chaos painting image from Wikimedia Commons
          fetch(`https://en.wikipedia.org/w/api.php?action=query&titles=File:Assistants_and_George_Frederic_Watts_-_Chaos_-_Google_Art_Project.jpg&prop=imageinfo&iiprop=url&iiurlwidth=600&format=json&origin=*`)
            .then(response => response.json())
            .then(data => {
              const pages = data.query?.pages;
              if (pages) {
                const pageId = Object.keys(pages)[0];
                const page = pages[pageId];
                const fileUrl = page?.imageinfo?.[0]?.thumburl || page?.imageinfo?.[0]?.url;
                if (fileUrl) {
                  imageUrl = fileUrl;
                  renderMyth(myth, extract, imageUrl, imageCaption);
                }
              }
            })
            .catch(() => {
              // Fallback to default image if fetch fails
            });
          // Render with extract even if image hasn't loaded yet
          if (extract) {
            renderMyth(myth, extract, imageUrl, imageCaption);
          }
          // Skip culture mythology fallback for Greek Cosmogony since we're using a custom image
        } else if (myth.slug === 'greek-eschatology') {
          // Fetch the specific Zeus de Smyrne image from Wikimedia Commons
          // Try to find the Zeus statue image - we'll search for common Zeus statue filenames
          fetch(`https://en.wikipedia.org/w/api.php?action=query&titles=File:Zeus_de_Smyrne.jpg&prop=imageinfo&iiprop=url&iiurlwidth=600&format=json&origin=*`)
            .then(response => response.json())
            .then(data => {
              const pages = data.query?.pages;
              if (pages) {
                const pageId = Object.keys(pages)[0];
                const page = pages[pageId];
                // Check if page exists (not -1 which means missing)
                if (pageId !== '-1') {
                  const fileUrl = page?.imageinfo?.[0]?.thumburl || page?.imageinfo?.[0]?.url;
                  if (fileUrl) {
                    imageUrl = fileUrl;
                    renderMyth(myth, extract, imageUrl, imageCaption);
                  }
                }
              }
            })
            .catch(() => {
              // Fallback to default image if fetch fails
            });
          // Render with extract even if image hasn't loaded yet
          if (extract) {
            renderMyth(myth, extract, imageUrl, imageCaption);
          }
          // Skip culture mythology fallback for Greek Eschatology since we're using a custom image
        } else if (!imageUrl && myth.culture) {
          // If no image from main page, try culture mythology page as fallback
          const culturePage = `${myth.culture} mythology`;
          getWikipediaExtractWithImage(culturePage).then(cultureResult => {
            if (cultureResult?.imageUrl) {
              imageUrl = cultureResult.imageUrl;
              imageCaption = cultureResult.imageCaption || null;
              renderMyth(myth, extract, imageUrl, imageCaption);
            }
          }).catch(() => {});
        }

        if (extract || imageUrl) {
          renderMyth(myth, extract, imageUrl, imageCaption);
        }

        // Also try to fetch related content if available (e.g., culture mythology page)
        if (myth.culture && extract) {
          const culturePage = `${myth.culture} mythology`;
          getWikipediaExtract(culturePage).then(cultureExtract => {
            if (cultureExtract && extract) {
              const combined = extract + '\n\n' + cultureExtract.substring(0, 1000);
              renderMyth(myth, combined, imageUrl, imageCaption);
            }
          }).catch(() => {
            // Silently fail if culture page doesn't exist
          });
        }

        // For Greek eschatology, also fetch content from Deucalion and Ages of Man pages
        if (myth.slug === 'greek-eschatology') {
          Promise.all([
            getWikipediaExtract('Deucalion'),
            getWikipediaExtract('Ages of Man')
          ]).then(([deucalionExtract, agesExtract]) => {
            let additionalContent = '';
            if (deucalionExtract) {
              additionalContent += '\n\n' + deucalionExtract.substring(0, 800);
            }
            if (agesExtract) {
              additionalContent += '\n\n' + agesExtract.substring(0, 800);
            }
            if (additionalContent && extract) {
              const combined = extract + additionalContent;
              renderMyth(myth, combined, imageUrl, imageCaption);
            }
          }).catch(() => {
            // Silently fail if related pages don't exist
          });
        }
      });
    }

    loadMythDetail();
  </script>
</body>
</html>

